<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tap Master</title>

    <!-- 1. Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <!-- 2. MONETAG AD SDK -->
    <script src="https://libtl.com/sdk.js" data-zone="10252050" data-sdk="show_10252050"></script>

    <style>
        /* --- DESIGN & STYLES --- */
        body {
            background-color: #121212; /* Dark Mode */
            color: #ffffff;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            padding: 20px;
            padding-bottom: 30px;
        }

        /* Header */
        .header { text-align: center; margin-top: 10px; opacity: 0.8; font-size: 14px; }

        /* Score */
        .score-box { 
            font-size: 48px; 
            font-weight: 800; 
            margin: 10px 0;
            text-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
        }

        /* The Tap Button */
        .game-area { flex-grow: 1; display: flex; align-items: center; justify-content: center; }
        .coin {
            width: 260px; height: 260px;
            background: radial-gradient(circle at 30% 30%, #ffd700, #ff8c00);
            border-radius: 50%;
            box-shadow: 0 0 40px rgba(255, 215, 0, 0.4), inset -10px -10px 20px rgba(0,0,0,0.3);
            display: flex; align-items: center; justify-content: center;
            font-size: 100px; cursor: pointer; transition: transform 0.1s;
        }
        .coin:active { transform: scale(0.95); }

        /* Buttons Area */
        .controls { width: 100%; display: flex; flex-direction: column; gap: 10px; max-width: 350px; }
        
        .btn {
            border: none; padding: 14px; border-radius: 12px;
            font-size: 16px; font-weight: bold; cursor: pointer;
            width: 100%; display: flex; justify-content: center; align-items: center; gap: 8px;
            color: white; transition: opacity 0.2s;
        }
        .btn:active { opacity: 0.8; transform: scale(0.98); }
        
        .btn-ad { background: linear-gradient(90deg, #00c6ff, #0072ff); box-shadow: 0 4px 15px rgba(0, 114, 255, 0.3); }
        .btn-rank { background: #333; border: 1px solid #444; }

        /* Leaderboard Modal */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 100; flex-direction: column; padding: 20px;
            box-sizing: border-box;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .close-btn { font-size: 28px; cursor: pointer; color: #888; }
        
        .leaderboard-list { overflow-y: auto; flex: 1; }
        .user-row {
            display: flex; justify-content: space-between; padding: 12px;
            border-bottom: 1px solid #333; font-size: 16px;
        }
        .user-row:nth-child(1) { color: #ffd700; font-weight: bold; } /* Gold for #1 */
        .user-row:nth-child(2) { color: #c0c0c0; } /* Silver for #2 */
        .user-row:nth-child(3) { color: #cd7f32; } /* Bronze for #3 */

        /* Floating +1 Animation */
        .float-text {
            position: absolute; color: #fff; font-weight: bold; font-size: 28px;
            pointer-events: none; animation: floatUp 0.8s ease-out forwards;
        }
        @keyframes floatUp { 
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-100px); opacity: 0; }
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="header" id="user-info">Loading Player...</div>

        <div class="score-box">
            ü™ô <span id="score">0</span>
        </div>

        <div class="game-area">
            <div class="coin" id="coin">
                $
            </div>
        </div>

        <div class="controls">
            <button id="ad-btn" class="btn btn-ad">
                üì∫ Watch Ad (+1000 Coins)
            </button>
            <button id="lb-btn" class="btn btn-rank">
                üèÜ Leaderboard
            </button>
        </div>
    </div>

    <!-- Leaderboard Modal Window -->
    <div id="lb-modal" class="modal">
        <div class="modal-header">
            <h2>üèÜ Top Players</h2>
            <span class="close-btn" id="close-lb">&times;</span>
        </div>
        <div id="lb-list" class="leaderboard-list">Loading...</div>
    </div>

    <!-- JAVASCRIPT LOGIC (Firebase + Game) -->
    <script type="module">
        // 1. IMPORT FIREBASE FUNCTIONS
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, get, update, query, orderByChild, limitToLast } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // 2. YOUR CONFIGURATION
        const firebaseConfig = {
            apiKey: "AIzaSyD339qRMQmBCdB8FETbCK2DOf6oMETeudE",
            authDomain: "zplaybox-6d198.firebaseapp.com",
            databaseURL: "https://zplaybox-6d198-default-rtdb.firebaseio.com",
            projectId: "zplaybox-6d198",
            storageBucket: "zplaybox-6d198.firebasestorage.app",
            messagingSenderId: "62948869233",
            appId: "1:62948869233:web:6f65d78f5a9c8134dc07d0",
            measurementId: "G-XLFK0NVKS8"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Initialize Telegram
        const tg = window.Telegram.WebApp;
        tg.expand();

        // Game Variables
        let userId = null;
        let username = "Guest";
        let score = 0;
        let unsavedClicks = 0; // Buffer to reduce database writes

        // HTML Elements
        const scoreEl = document.getElementById('score');
        const userEl = document.getElementById('user-info');
        const lbModal = document.getElementById('lb-modal');
        const lbList = document.getElementById('lb-list');

        // --- STEP A: IDENTIFY USER & LOAD DATA ---
        if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
            userId = tg.initDataUnsafe.user.id.toString();
            username = tg.initDataUnsafe.user.first_name || "Anon";
            userEl.innerText = `Player: ${username}`;

            // Load data from Firebase
            const userRef = ref(db, 'users/' + userId);
            get(userRef).then((snapshot) => {
                if (snapshot.exists()) {
                    // User exists, load score
                    score = snapshot.val().score;
                } else {
                    // New user, save initial data
                    set(userRef, { username: username, score: 0 });
                    score = 0;
                }
                scoreEl.innerText = score;
            }).catch((err) => {
                console.error(err);
                userEl.innerText = "Connection Error";
            });

        } else {
            userEl.innerText = "Playing as Guest (Score not saved)";
        }

        // --- STEP B: SAVE LOOP (Sync every 2 seconds) ---
        setInterval(() => {
            if (userId && unsavedClicks > 0) {
                const userRef = ref(db, 'users/' + userId);
                update(userRef, {
                    score: score,
                    username: username // Update name if changed
                });
                unsavedClicks = 0; // Reset buffer
            }
        }, 2000);

        // --- STEP C: TAP LOGIC ---
        document.getElementById('coin').addEventListener('click', (e) => {
            score++;
            unsavedClicks++;
            scoreEl.innerText = score;

            // Visual Effect
            const float = document.createElement('div');
            float.innerText = '+1';
            float.className = 'float-text';
            float.style.left = e.clientX + 'px';
            float.style.top = e.clientY + 'px';
            document.body.appendChild(float);
            setTimeout(() => float.remove(), 800);

            tg.HapticFeedback.impactOccurred('medium');
        });

        // --- STEP D: MONETAG ADS ---
        document.getElementById('ad-btn').addEventListener('click', () => {
            if (typeof show_10252050 === 'function') {
                show_10252050().then(() => {
                    // Reward
                    const reward = 1000;
                    score += reward;
                    unsavedClicks += reward; 
                    scoreEl.innerText = score;
                    tg.showAlert(`Success! +${reward} Coins`);
                    
                    // Force Save Immediately
                    if(userId) {
                        update(ref(db, 'users/' + userId), { score: score });
                        unsavedClicks = 0;
                    }
                }).catch(e => {
                    tg.showAlert("Ad skipped or failed.");
                });
            } else {
                tg.showAlert("Ad system loading... wait 5 seconds.");
            }
        });

        // --- STEP E: LEADERBOARD ---
        document.getElementById('lb-btn').addEventListener('click', () => {
            lbModal.style.display = 'flex';
            lbList.innerHTML = '<div style="text-align:center; padding:20px;">Loading...</div>';

            // Get Top 20 users
            const topUsersQuery = query(ref(db, 'users'), orderByChild('score'), limitToLast(20));
            
            get(topUsersQuery).then((snapshot) => {
                lbList.innerHTML = '';
                const users = [];
                
                snapshot.forEach((child) => {
                    users.push(child.val());
                });

                // Firebase returns low->high, we reverse to get high->low
                users.reverse();

                if(users.length === 0) {
                    lbList.innerHTML = '<div style="text-align:center;">No players yet</div>';
                    return;
                }

                users.forEach((u, index) => {
                    const row = document.createElement('div');
                    row.className = 'user-row';
                    row.innerHTML = `
                        <span>#${index + 1} ${u.username.substring(0, 15)}</span>
                        <span>${u.score.toLocaleString()}</span>
                    `;
                    lbList.appendChild(row);
                });
            });
        });

        document.getElementById('close-lb').addEventListener('click', () => {
            lbModal.style.display = 'none';
        });

    </script>
</body>
</html>
