<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tap to Earn</title>
    
    <!-- TELEGRAM & AD SDKs -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://libtl.com/sdk.js" data-zone="10252050" data-sdk="show_10252050"></script>

    <style>
        body {
            background-color: #000;
            color: #fff;
            font-family: 'Segoe UI', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }

        /* PROFILE SECTION (Where Username shows) */
        .profile-card {
            background: #1a1a1a;
            width: 90%;
            padding: 15px;
            margin-top: 20px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            border: 1px solid #333;
        }
        .avatar {
            width: 50px; height: 50px;
            background: #444; border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            font-size: 24px;
        }
        .user-details h3 { margin: 0; font-size: 18px; color: #fff; }
        .user-details p { margin: 0; font-size: 14px; color: #00ccff; }

        /* COIN DISPLAY */
        .coin-display { margin-top: 30px; text-align: center; }
        .coin-display h1 { font-size: 50px; margin: 0; }
        .coin-display span { font-size: 20px; color: #888; }

        /* CLICK BUTTON */
        .tap-area {
            flex-grow: 1;
            display: flex; justify-content: center; align-items: center;
        }
        .tap-btn {
            width: 240px; height: 240px;
            background: radial-gradient(circle, #f0932b, #b33939);
            border-radius: 50%;
            border: 5px solid #fff;
            box-shadow: 0 0 30px #f0932b;
            cursor: pointer;
            transition: transform 0.1s;
        }
        .tap-btn:active { transform: scale(0.95); }

        /* LOADING SCREEN */
        #loading {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 999;
            display: flex; justify-content: center; align-items: center;
            font-size: 24px;
        }
    </style>
</head>
<body>

    <!-- Loading Screen -->
    <div id="loading">Logging in...</div>

    <!-- User Profile Header -->
    <div class="profile-card">
        <div class="avatar">ðŸ‘¤</div>
        <div class="user-details">
            <h3 id="display-username">Guest</h3>
            <p>ID: <span id="display-id">...</span></p>
        </div>
    </div>

    <!-- Coin Balance -->
    <div class="coin-display">
        <h1 id="score">0</h1>
        <span>COINS</span>
    </div>

    <!-- Tap Button -->
    <div class="tap-area">
        <div class="tap-btn" id="tap-btn"></div>
    </div>

    <!-- Ad Button -->
    <div style="width:90%; margin-bottom: 20px;">
        <button id="ad-btn" style="width:100%; padding:15px; background:#007bff; color:white; border:none; border-radius:10px; font-weight:bold;">
            Watch Ad (+1000 Coins)
        </button>
    </div>

    <!-- LOGIC SCRIPT -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, get, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // --- 1. YOUR FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyD339qRMQmBCdB8FETbCK2DOf6oMETeudE",
            authDomain: "zplaybox-6d198.firebaseapp.com",
            databaseURL: "https://zplaybox-6d198-default-rtdb.firebaseio.com",
            projectId: "zplaybox-6d198",
            storageBucket: "zplaybox-6d198.firebasestorage.app",
            messagingSenderId: "62948869233",
            appId: "1:62948869233:web:6f65d78f5a9c8134dc07d0",
            measurementId: "G-XLFK0NVKS8"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const tg = window.Telegram.WebApp;
        tg.expand();

        // Variables
        let userId = null;
        let username = "Unknown";
        let score = 0;

        // UI References
        const scoreEl = document.getElementById('score');
        const usernameEl = document.getElementById('display-username');
        const idEl = document.getElementById('display-id');
        const loadingEl = document.getElementById('loading');

        // --- 2. LOGIN LOGIC (Start App) ---
        async function startApp() {
            // Check if running inside Telegram
            if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                
                // Get Telegram Data
                const user = tg.initDataUnsafe.user;
                userId = user.id.toString(); // IMPORTANT: This is the Key
                username = user.first_name + (user.last_name ? " " + user.last_name : "");

                // Update UI immediately
                usernameEl.innerText = username;
                idEl.innerText = userId;

                // Fetch Score from Firebase
                const userRef = ref(db, 'users/' + userId);
                try {
                    const snapshot = await get(userRef);
                    if (snapshot.exists()) {
                        // USER EXISTS: Load their score
                        const data = snapshot.val();
                        score = data.score || 0;
                        console.log("Welcome back, " + username);
                    } else {
                        // NEW USER: Create account in DB
                        await set(userRef, {
                            username: username,
                            score: 0,
                            joined: Date.now()
                        });
                        score = 0;
                        console.log("New user created");
                    }
                    // Update Score on Screen
                    scoreEl.innerText = score;
                } catch (error) {
                    console.error("Database Error:", error);
                    alert("Error loading data. Check internet.");
                }

            } else {
                // Not in Telegram (Testing in Browser)
                usernameEl.innerText = "Browser Tester";
                idEl.innerText = "000000";
                alert("Please open this inside Telegram to save progress.");
            }

            // Hide Loading Screen
            loadingEl.style.display = 'none';
        }

        // --- 3. TAP LOGIC ---
        document.getElementById('tap-btn').addEventListener('click', () => {
            if (!userId) return; // Don't allow taps if not logged in

            score++;
            scoreEl.innerText = score;

            // SAVE to Firebase
            // To save battery/data, we use debounce or save specifically. 
            // For simplicity here, we update the DB logic.
            update(ref(db, 'users/' + userId), {
                score: score,
                username: username // Ensure name is always current
            });

            tg.HapticFeedback.impactOccurred('light');
        });

        // --- 4. AD LOGIC ---
        document.getElementById('ad-btn').addEventListener('click', () => {
             if (typeof show_10252050 === 'function') {
                show_10252050().then(() => {
                    score += 1000;
                    scoreEl.innerText = score;
                    // Save immediately after ad
                    if(userId) {
                        update(ref(db, 'users/' + userId), { score: score });
                    }
                    tg.showAlert("Success! +1000 Coins");
                });
             } else {
                 alert("Ad loading...");
             }
        });

        // Run the startup
        startApp();

    </script>
</body>
</html>
